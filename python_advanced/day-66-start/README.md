# 66일차 목표: 나만의 REST API 서비스 구축하기

지난 33일차 수업에서 API에 대해 배운 이후로 ISS 위치, 질의응답 기술 및 트윌리오(Twilio)와 같은 많은 공개 API를 사용했습니다. 대부분의 경우, API를 통해 특정 웹 사이트의 데이터나 서비스를 이용할 수 있습니다.

많은 기업들은 비트코인 가격, 음식점 후기와 같은 중요한 데이터를 수집하여 유료로 이러한 데이터에 접근할 수 있도록 개발자들에게 API를 제공하고 있습니다. 이러한 API는 그 안에 내재된 데이터/서비스의 가치에 따라 월 9~99달러의 액세스 비용을 청구할 수 있으며, 일부 기업은 API 호출당 요금을 부과하기도 합니다.

만약 다른 사람들이 사용하고 싶어 할 수도 있는 정보에 여러분이 접근할 수 있다면 어떻게 할까요? 예를 들어 여러분이 특정 도시의 모든 카페에 대한 데이터를 수집하여 원격 근무에 적합한 카페를 찾아냈다면, API를 만들어 사람들이 당신의 데이터에 접근하도록 청구할 수 있을 겁니다.

그런데 API는 어떻게 만들 수 있을까요?

바로 그것이 오늘 수업의 주제입니다. 플라스크를 사용하여 기초부터 시작하여 완전한 REST API 구축하는 방법에 대해 알아보겠습니다.

시작 프로젝트 다운로드
1. Starting Files - cafe-api-start.zip 파일을 다운로드하세요.
2. 프로젝트의 압축을 풀고 파이참에서 여세요.
3. 필요한 패키지를 모두 설치하고(임포트) 빨간색 밑줄이 없는지 확인하세요.
시작 파일은 cafes.db라는 SQ 라이트 데이터베이스로 이루어져 있으며, 이전에 데이터베이스를 만들었던 것과 같은 방식으로 만들었습니다. 런던 주변의 카페들로 구성된 레코드가 다수 추가되었는데, 실제로 제가 일하기 위해 즐겨 찾는 카페들입니다.
4. DB 뷰어를 사용하여 데이터베이스를 살펴보고 데이터베이스의 필드를 숙지하시기 바랍니다.


# HTTP GET - 무작위 카페
데이터베이스가 원격 근무 가능한 카페로 구성되어 있다는 점을 고려했을 때 추정할 수 있는 API의 용도 중 하나는 사용자가 이용할 수 있는 임의의 카페 정보를 제공하려는 개발자의 사용 사례일 것입니다. 이에 임의의 카페 정보를 제공하는 /random 경로를 생성해 보겠습니다.

1. main.py에 GET 요청을 할 수 있는 /random 경로를 만듭니다.
해답
https://gist.github.com/angelabauer/f5509db5a9581c49fc532c3e94f433e2

2. 누군가 /random 경로로 GET 요청을 하면 플라스크 서버가 데이터베이스에서 임의의 카페를 가져와야 합니다.
참고: 현 시점에서는 리턴에 대해 걱정하지 마세요.
해답
https://gist.github.com/angelabauer/296c938b2f6a48a0b7fb34cf18d28c70

보통은 render_template()을 사용하여 HTML 템플릿을 반환했지만 이번에는 서버가 API 역할을 하므로 필요한 데이터가 포함된 JSON을 리턴하고자 합니다. 실제 공개 API처럼 말이죠.
예시. ISS API: http://api.open-notify.org/iss-now.json
이를 위해서는 random_cafe SQL 알케미 객체를 JSON으로 변환해야 하는데, 이러한 프로세스를 직렬화라고 합니다.
플라스크에 jsonify()라는 직렬화 헬퍼 메소드가 내장되어 있기는 하지만, 리턴할 JSON의 구조는 우리가 제공해야 합니다.

3. jsonify에 관한 문서를 사용하여 /random 경로를 작동시키는 방법을 찾아보세요. 제대로 작동했다면 main.py를 실행하고 localhost:5000/random으로 이동했을 때 다음과 같은 화면이 표시되어야 합니다.
해답
https://gist.github.com/angelabauer/776be425f5a442f4cc5b780e083fbe8c

문서에 설명된 방법은 JSON 반환 값을 완벽하게 제어할 수 있도록 최대한의 유연성을 제공합니다. 예를 들어 id와 같은 일부 속성을 생략하여 반환 값을 구성하거나, 불리언 속성을 편의 시설이라는 이름의 하위 섹션으로 그룹화할 수도 있습니다.

예시 코드
https://gist.github.com/angelabauer/e8542ae3ffae75584f6f4771b95c5436


그러나 특정 레코드에 있는 모든 데이터를 반환하고 싶은 경우가 대부분일 텐데, 모든 경로에 대해 해당 코드를 모두 작성해야 한다면 정말 미칠 노릇일 겁니다.
따라서 데이터베이스 행 객체를 JSON으로 직렬화하기 위한 또 다른 방법으로 먼저 객체를 사전으로 변환한 다음 jsonify()를 사용하여 사전(JSON과 매우 유사한 구조를 가짐)을 JSON으로 변환할 수 있습니다.

코드
https://gist.github.com/angelabauer/ce2f38fae6fd84b854296d7d4303cec0



# HTTP GET - 모든 카페
모든 카페 목록을 보여주는 웹 사이트를 만들기 위해서는 데이터베이스에 있는 모든 카페 정보를 가져와야 합니다.
예) https://laptopfriendly.co/london

도전 과제:
1. /all이라는 또 다른 GET 경로를 생성하세요.
2. /all 경로에 대해 GET 요청이 이루어지면 서버가 데이터베이스의 모든 카페를 JSON으로 반환하게 됩니다.
예)
https://gist.github.com/angelabauer/889a0e57359ede23e7b09a7902a45a6e

해답
https://gist.github.com/angelabauer/af4fd5469c5fde90317a740632aee934




# HTTP GET - 카페 찾기
1. /search 경로를 생성하여 특정 위치에 있는 카페를 검색하세요.
예. cafes.db를 보면 필드 위치를 확인할 수 확인할 수 있는데, 이는 카페가 위치한 대략적인 지역입니다.
API가 특정 지역의 모든 카페를 리턴하도록 해보세요.
사용자는 /search 경로에 GET 요청을 하고 위치를 매개변수로 전달하게 됩니다.

힌트: 매개변수는 ?와 함께 URL에 전달됩니다.
예) lat 및 lon 매개변수를 ISS 추적 API에 전달합니다.
http://api.open-notify.org/iss-pass.json?lat=50&lon=-0.1

성공할 경우 다음과 같은 작업을 수행할 수 있습니다.

사용자가 매개변수로 전달한 위치가 존재하지 않는 경우 다음과 같이 표시됩니다.

해답
https://gist.github.com/angelabauer/12f2ffbcb135cb424700d331d6c0dfeb



# 포스트맨 - 만능 API 테스트 도구
상상이 되시겠지만 API를 테스트할 때 수많은 매개변수를 사용해야 한다면 그 모든 매개변수를 브라우저 URL 표시줄에 입력하느라 곧 지쳐버릴 테고, 그 과정에 오류가 발생할 가능성도 매우 높습니다.
그럼 개발자들은 API를 어떻게 테스트할까요? 이때 사용할 수 있는 최고의 도구 중 하나가 바로 Postman입니다.
Postman을 사용하면 요청 매개변수에 대한 키-값 쌍을 추가할 수 있으며, URL 형식이 자동으로 지정됩니다.
또한 API 문서도 자동으로 생성할 수 있습니다.
https://learning.postman.com/docs/publishing-your-api/documenting-your-api/

(이건 잠시 후에 해 보겠습니다)

Postman은 다음 링크에서 무료로 다운로드할 수 있습니다. https://www.postman.com/downloads/

API 경로 테스트를 성공적으로 마쳤다면, 그다음에는 Cafe & Wifi라는 새로운 컬렉션을 만들고 기존의 경로를 모두 컬렉션에 추가해 보세요.

최종적으로 컬렉션에 3개의 경로가 모두 저장되어 있어야 합니다. 나중에 API에 대한 문서를 생성하려면 모든 경로를 제대로 저장하는 것이 중요합니다.




# HTTP POST - 새로운 카페
데이터베이스에 새 카페를 추가하려면 어떻게 해야 할까요? 예를 들면 사용자들이 발견한 카페를 추가할 수 있는 웹 사이트가 있나요?
예) https://laptopfriendly.co/suggest
WTForm 또는 HTML 양식을 작성하지 않고 API를 테스트하려면 어떻게 해야 할까요? POST 요청이 올 가능성이 있으니까 말이죠.
다행히 Postman을 사용하면 쉽게 할 수 있습니다.
Postman의 본문 탭에 입력하는 키-값 쌍은 <input> 요소와 동일합니다.

예)
<label>Name of Cafe</label>
<input name="name">
<label>Google Map URL Link</label>
<input name="map_url">
POST 요청을 너무 잘 만들어서 'POSTman'이라고 하는 사람들도 있답니다. 😜
여러분이 Postman으로 만들어야 할 것은 다음과 같습니다.

해답
https://gist.github.com/angelabauer/64d75b1ee4515174b6a45a30b8ba5dd6



# HTTP PATCH - 카페의 커피 가격
카페 데이터베이스의 필드 중에는 블랙커피 한 잔 가격이라는 필드가 있습니다. 이는 사용자들이 그 카페의 메뉴 가격을 가늠할 수 있는 좋은 방법입니다. 하지만 카페들은 종종 가격을 바꿉니다. 만약 사용자가 어느 카페의 가격 변동 사항을 제출하고 싶다면 어떻게 할까요?
사용자가 카페의 id를 알고 있다면(GET 요청을 해서 모든 카페에 대한 데이터를 가져오면 카페 id를 알 수 있습니다) 카페의 coffee_price 필드를 업데이트할 수 있습니다.
이런 상황에서는 카페의 나머지 데이터는 변경할 필요가 없기 때문에 PATCH 요청이 더 효율적일 수 있습니다.

1. main.py에 PATCH 요청 경로를 생성하여 API에 대한 PATCH 요청을 처리하세요. API가 RESTful이 되기 위한 이상적인 경로는 다음과 같아야 합니다.

/update-price/<cafe_id>

힌트 1: https://flask.palletsprojects.com/en/1.1.x/quickstart/#variable-rules

사용자가 localhost:5000/update-price/22로 이동하면 id가 22인 카페가 업데이트됩니다.
힌트 2: 또한 사용자는 요청을 매개변수로 전달하여 업데이트된 블랙 커피 한 잔 가격을 제공해야 합니다.
올바르게 수행한 경우 다음과 같이 되고, Postman에서 API를 테스트하고 응답을 성공적으로 얻을 수 있어야 합니다.
참고: 경로에 id가 존재하지 않을 가능성이 있는데, 이 경우 사용자에게 올바른 피드백을 제공해야 합니다.

해답
https://gist.github.com/angelabauer/bb25bbb9e969ab4a201f4282354a6512

참고: 리소스를 찾을 수 없고 오류가 발생하여 올바른 HTTP 코드가 리턴되지 않았습니다. 이 경우 '리소스를 찾을 수 없음'이라는 404 응답이 리턴되어야 하는데, 그 대신 '확인'이라는 200이 표시됩니다.

이렇게 하면 응답과 함께 HTTP 코드를 전달할 수 있습니다.

코드
https://gist.github.com/angelabauer/dbae77d766cf51942b0c8852fd8470a3



# HTTP DELETE - 폐쇄된 카페
좋아하는 카페가 문을 닫는 것만큼 슬픈 일도 없죠. 하지만 현실을 받아들이고 계속 나아가야 합니다. 그리고 서버에 DELETE 요청을 하고 데이터베이스를 업데이트해야 하죠.
하지만 아무나 데이터베이스에서 항목을 삭제하도록 할 수는 없습니다. 그렇게 되면 머지 않아 누군가 실수로 모든 정보를 삭제해버릴 수도 있으니까요.
이런 경우 api-key를 요구하여 보안 기능을 추가할 수 있습니다. "TopSecretAPIKey"라는 API 키 값이 있으면 삭제 요청을 할 수 있고, 그렇지 않은 경우에는 해당 요청을 할 권한이 없다고 알려줍니다. HTTP 상태 코드인 403로 알려주는 거죠.

https://httpstatuses.com/ 에서 모든 HTTP 코드를 확인하세요.

1. DELETE 경로를 /report-closed/<cafe_id>에 추가하여 이 과제를 완료해보세요.
예를 들어, Postman을 통해 다음과 같이 요청할 수 있습니다.
사용자가 잘못된 API 키 값을 가지고 있는 경우 다음과 같은 응답을 리턴합니다.

해당 id의 카페가 존재하지 않는 경우에는 다음과 같은 응답을 리턴합니다.

해답
https://gist.github.com/angelabauer/33d1ec5c04a0eebef89b18bc2be54836



# API 문서 작성하기
다른 사람들이 우리의 API를 사용하도록 하려면 사용 방법을 문서화해야 합니다. 사람들은 우리 서버의 코드를 볼 수 없으므로 API 제약 조건을 통해 서버와 상호 작용하는 방법을 알려줘야 합니다.
예를 들어 경로는 무엇인지, 필요한 매개변수는 무엇인지 등에 대해서 말이죠.
하지만 다행히도 Postman에서 모든 요청을 하고 각 요청에 이름과 설명을 부여해주면 Postman이 자동으로 문서를 생성해줍니다.

1. 각 요청을 수행했으며 예상한 대로 작동하는지 확인합니다.
2. 모든 요청이 동일한 컬렉션(제가 만든 컬렉션 이름은 Cafe & Wi-Fi입니다)에 저장되었는지 확인합니다.
3. 컬렉션 이름 옆에 있는 세 개의 점을 클릭하여 '문서 게시(Publish Docs)'로 이동합니다.
4. 문서 게시 단계가 완료되면 다음과 같은 결과를 얻을 수 있습니다.
예) 다음 링크에서 제가 만든 문서를 참고하세요https://documenter.getpostman.com/view/2568017/TVRhd9qR
5. 이제 index.html을 수정하여 API 문서에 앵커 태그를 포함시킬 수 있습니다.

